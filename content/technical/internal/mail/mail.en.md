---
title: "97 - mail"
menu:
  main:
    name: "mail"
    identifier: "technical/internal/mail/mail"
    parent: "technical/internal"
---
# Email Adress

A user can have multiple email addresses. See the attribute [here](../../types/user).

A valid email is not expired and has been confirmed (or unconfirmed if not requested):

```
valid = (NOT date_expire) AND (NOT date_request_confirm OR date_confirm)
```


An email be chosen from the list. Sometimes it is explicitly specified and sometimes the decision will be made by the mailer processor.

The following Emails are generated by easydb (for details, see [email-confirmation](../../../sysadmin/konfiguration/email)):


| Origin        | Template                | Type                 | explicitly specify Email? |
|-----------------|-------------------------|---------------------|----------------------------|
| /api/user       | welcome_new_user        | immediate           | Yes                         |
| /api/user       | updated_self_service    | immediate           | Yes                         |
| /api/user       | updated_record          | immediate           | Yes                         |
| /api/user       | forgot_password         | immediate           | Yes                         |
| /api/user       | confirm_email           | immediate           | Yes                         |
| /api/user       | require_password_change | immediate           | Yes                         |
| /api/user       | login_disabled          | immediate           | Yes                         |
| /api/collection | share_collection        | immediate           | Yes                         |
| /api/db         | transition_resolve      | immediate/scheduled | No                       |
| /api/db         | transition_reject       | immediate/scheduled | No                       |
| export_worker   | transport               | immediate           | Yes                         |
| export_worker   | export                  | immediate           | Yes                         |

# Mailer

The mailer processes the queue in a "server/mailer/interval" second and uses the configured "server/mailer/sender_address" and "server/mailer/envelope_address".

The steps are:

(1) immediate Emails processing
(2) scheduled Emails processing
(3) failed_delay Emails processing
(4) failed_delete Emails processing

## (1) immediate Emails processing

The mailer fetches itself:

immediate entries and
scheduled entries whose user has no schedule,


The address can be either:

explicitly specified, or
come from the user: then the first valid email with use_for_mail will be taken

The e-mail is built and sent:

if everything is OK, the entry will be deleted
if no address is found, an ERROR is logged and the entry is marked as "failed_delete" (see 4)
if the e-mail cannot be built, an ERROR is logged and the entry is marked as "failed_delete" (see 4)
If the e-mail cannot be delivered, the entry "failed_delay" will be marked (see 3)

## (2) scheduled email processing

The mailer gets itself:

scheduled entries that should be edited after the user schedule and


The address is determined as described in (1) and:

if the entry is not batchable, an e-mail will be built and sent
batchable entries are built per user and template and sent as a single email

The error handling is the same as for (1)

## (3) failed_delay Emails processing

The entry is updated: number of attempts, error and timestamp. If the number of attempts is >= "server/mailer/max_at_GO", the entry is marked as failed_delete.

## (4) failed_delete Emails processing

The entry is deleted.

TODO**: the administrator receives an e-mail with the information.
